name: Deploy Vue.js Frontend with PM2

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy source files to VPS
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='dist' \
            --chmod=D755,F644 \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_IP }}":"${{ secrets.DEPLOY_PATH }}"

      - name: Install dependencies and restart PM2
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no "${{ secrets.SERVER_USER }}"@"${{ secrets.SERVER_IP }}" << 'ENDSSH'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Installer les dépendances
            npm install
            
            # Arrêter l'ancien processus PM2 s'il existe
            pm2 delete ebetstream-frontend 2>/dev/null || true
            
            # Démarrer avec PM2
            pm2 start npm --name "ebetstream-frontend" -- run dev -- --host 0.0.0.0 --port 3000
            
            # Sauvegarder la configuration PM2
            pm2 save
            
            echo "✅ Frontend déployé avec PM2 à: $(date)"
            pm2 list
          ENDSSH